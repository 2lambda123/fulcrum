<%= javascript_tag "var AUTH_TOKEN = '#{form_authenticity_token}';" if protect_against_forgery? %>
<script id="story_tmpl" type="text/x-jQuery-tmpl">
  {{if story.estimable}}
  <div class="state-actions">
    <form>
      {{each $item.story.point_values()}}
      <input type="button" class="estimate" value="${$value}"/>
      {{/each}}
    </form>
  </div>
  {{else story.events.length > 0}}
  <div class="state-actions">
    <form>
      {{each story.events}}
        <input type="button" class="transition ${$value}" value="${$value}"/>
      {{/each}}
    </form>
  </div>
  {{/if}}
  <div class="story-icons">
    {{if $item.view.saveInProgress}}
    <img src="/images/throbber.gif" alt="Saving ...">
    {{else}}
    <img src="/images/expand.png" class="expand" alt="Expand">
    {{/if}}
    <img src="/images/${story.story_type}.png" class="story_type" alt="${story.story_type}" title="${story.story_type}: ${story.id}">
    {{if story.estimated}}
    <span class="estimate estimate_${story.estimate}">${story.estimate}</span>
    {{/if}}
  </div>
  <div class="story-title">${story.title}{{if $item.story.owned_by()}}<abbr class="initials" title="${$item.story.owned_by().get("name")}">${$item.story.owned_by().get("initials")}</abbr>{{/if}}</div>
  
</script>
<script id="story_form" type="text/x-jQuery-tmpl">
  <p>
    <label for="story_title">Title</label><br/>
    <input type="text" id="story_title" value="${title}"/>
  </p>
</script>

<script type="text/javascript">
$(function() { 
  window.Project = new Project({
    id: <%= @project.id %>, point_values: <%= @project.point_values.to_json %>
  });
  window.Project.users.refresh(<%= @project.users.to_json.html_safe %>);
  window.Project.current_user = new User(<%= current_user.to_json.html_safe %>);
  window.App = new AppView;
  window.App.scaleToViewport();
  $(window).resize(App.scaleToViewport);

  <% if notice %>
    window.App.notice({
      title: 'Notice', text: '<%= notice %>',
      image: '<%= image_path('dialog-information.png') %>'
    });
  <% end %>

  <% if alert %>
    window.App.notice({
      title: 'Alert', text: '<%= alert %>', sticky: true,
      image: '<%= image_path('dialog-warning.png') %>'
    });
  <% end %>
});
</script>

<%= render :partial => 'projects/nav', :locals => {:project => @project} %>
| <a id="add_story" href="#">Add story</a>

<table class="stories" width="100%">
  <thead>
    <tr>
      <th>Done</th>
      <th>In Progress</th>
      <th>Backlog</th>
      <th>Chilly Bin</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="width: 25%"><div id="done" class="storycolumn"></div></td>
      <td style="width: 25%"><div id="in_progress" class="storycolumn sortable"></div></td>
      <td style="width: 25%"><div id="backlog" class="storycolumn sortable"></div></td>
      <td style="width: 25%"><div id="chilly_bin" class="storycolumn sortable"></div></td>
    </tr>
  </tbody>
</table>
